<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="./plugins/layui/layui.js"></script>
    <link rel="stylesheet" href="./plugins/layui/css/layui.css" />
    <link rel="stylesheet" href="./src/styles/page3.css" />

    <link rel="stylesheet" href="./plugins/swiper/swiper-bundle.min.css" />
    <script src="./plugins/swiper/swiper-bundle.min.js"></script>

    <!-- 高德api -->
    <script type="text/javascript">
      window._AMapSecurityConfig = {
        securityJsCode: "6653c0473726d0f1ab5b2ab0dbe162c4",
      };
    </script>
    <script src="https://cache.amap.com/lbs/static/es5.min.js"></script>
    <script src="https://webapi.amap.com/maps?v=2.0&key=7262dc147356ba13dc72224c66a04e1d&plugin=AMap.DistrictSearch"></script>

    <title>Urban Streetscapes</title>

    <style>
      /* 1. font-face 注册  2. font-family：使用 */
      @font-face {
        font-family: "BigShouldersInlineText-Black", "HarmonyOS_Sans_Thin";
        src: url("static/BigShouldersInlineText-Black.ttf"),
          url("static/HarmonyOS_Sans_Thin.ttf");
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      p {
        display: inline-block;
      }

      body,
      html {
        height: 100%;
        overflow: hidden;
      }

      .swiper {
        height: 100vh;
      }

      .swiper-slide {
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* home_1页面内容 */

      .home_pre {
        width: 100%;
        min-height: 100vh;
        background: url("static/bg.jpg") no-repeat center;
        background-size: cover;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        animation: bg 5s ease-in-out;
        position: relative;
        justify-content: center;
      }

      .home_pre > .content {
        width: 100%;
        position: absolute;
        z-index: 1;
        text-align: center;
        color: rgb(250, 250, 250);
        margin-top: -18%;
        letter-spacing: 1px;
        animation: title-animation 3.5s ease-in-out forwards;
      }

      .home_pre > .content > .heading {
        font-family: "BigShouldersInlineText-Black";
        font-weight: bolder;
        font-size: 200px;
        white-space: nowrap;
        text-shadow: 4px 4px 4px #000000aa;
      }

      .home_pre::before {
        width: 100%;
        height: 100%;
        content: "";
        position: absolute;
        animation: bg2 5s ease-in-out;
        background: url("static/preground.png");
        inset: 0;
        background-repeat: no-repeat;
        background-position: center;
        background-size: cover;
        overflow: hidden;
        z-index: 2;
      }

      @media screen and (max-width: 768px) {
        .home_pre > .content > .heading {
          font-size: 60px;
        }
      }

      @media screen and (max-width: 992px) {
        .home_pre > .content > .heading {
          font-size: 100px;
        }
      }

      @media screen and (min-height: 1050px) {
        .home_pre {
          font-size: 18px;
        }
      }

      @keyframes bg {
        0% {
          background-position: center -7em;
          opacity: 0;
        }

        50% {
          opacity: 1;
        }

        100% {
          background-position: center;
        }
      }

      @keyframes bg2 {
        0% {
          background-position: center -4em;
          opacity: 1;
        }

        50% {
          opacity: 1;
        }

        100% {
          background-position: center;
        }
      }

      @keyframes title-animation {
        from {
          transform: translateY(-30%);
        }

        to {
          transform: translateY(-10%);
        }
      }

      /* home_2页面内容 */

      .home {
        padding: 5px 40px 5px 50px;
        width: 100%;

        background-color: rgb(240, 240, 240);
        background-position: right;
        background-size: cover;
        overflow: auto;

        display: flex;
        flex-direction: column;
      }

      .home > .intro_pic {
        width: 100%;
        margin-bottom: 10px;
      }

      .home > .content {
        padding: 0 100px 0 100px;
        width: 100%;
      }

      .home > .content ::selection {
        background-color: rgb(207, 111, 9);
      }

      /* 嵌入文本中的容器 */
      .content_embedded {
        float: left;
        margin: 0 20px 20px 0;
        padding-top: 10px;
      }

      .content_embedded > .content_pic {
        margin-top: -130px;
        width: 400px;
      }

      .content_embedded > .video_area > video {
        width: 500px;
      }

      .home > .content > .text_area_1 {
        flex: 1;
        /* 下外边距 */
        /* margin-bottom: 1px; */
        margin-top: 20px;
        text-align: center;
        line-height: 60px;
        font-weight: bold;
        font-size: 30px;
        color: #444444;
      }

      .home > .content > .text_area_2 {
        /* 下外边距 */
        font-family: "HarmonyOS_Sans_Thin";
        text-align: justify;
        margin-top: 15px;
        margin-bottom: 5px;
        line-height: 30px;
        font-weight: normal;
        font-size: 16px;
        color: #444444;
      }

      .home > .content > .text_area_2 > .pic_text {
        /* 下外边距 */
        font-family: "HarmonyOS_Sans_Thin";
        text-align: left;
        margin-top: 5px;
        margin-bottom: 5px;
        line-height: 10px;
        font-weight: normal;
        font-size: 13px;
        color: #444444;
      }

      /* gallery */
      .content_gallery {
        display: flex;
        width: 50%;
        gap: 10px;
      }

      .content_gallery > .gallery_item {
        flex: 1;
        display: block;
        clear: both;
        margin-top: 10px;
      }

      .gallery_item > img {
        width: 100%;
      }

      .home > .content > .video_area {
        overflow: hidden;
      }

      /* 视频和文字统一设置样式 */
      .text_area_1,
      .text_area_2,
      .video_area {
        /* 圆角 */
        border-radius: 0px;
        /* 内边距 */
        padding: 3px;
      }

      /* 滑块内部样式 */
      .range_btn_group {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 18px;
        font-size: 4px;
        color: #000;
      }

      .range_item {
        border-bottom: 1px solid rgba(0, 0, 0, 0.25);
        padding-bottom: 20px;
        margin-bottom: 20px;
      }

      /*  ---------------------------------------------- 切换按钮 ------------------------------------- */
      /* 第一页 */
      .lang_buttons {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        margin-top: auto;
        width: 100%;
        z-index: 3;
      }

      .lang_btn {
        color: rgb(207, 111, 9);
        background: #fff;
        width: 20%;
        height: 30px;
        padding: 8px 20px;
        border-radius: 3em;
        font-weight: bold;
        transition: all ease-in-out 0.15s;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        margin-top: auto;
        margin: auto 10px 100px 10px;
        border: none;
      }

      .lang_btn:nth-child(1) {
        margin-bottom: 15px;
      }

      .lang_btn:nth-child(2) {
        margin-bottom: 100px;
      }

      .lang_btn.white {
        color: rgb(207, 111, 9);
      }

      .lang_btn.white:hover {
        color: #fff;
        background-color: rgb(207, 111, 9);
      }

      /* 第二页 */
      .page_menu {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .page_change_btn {
        width: 100%;
        height: min-content;
        padding: 5px 20px;
        border-radius: 2px;
        border: none;
        font-weight: light;
        transition: all ease-in-out 0.15s;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
      }

      /* 按钮内图标 */
      .page_change_btn > .menu_icon {
        color: #fff;
        height: 1rem;
        width: 1rem;
        margin: 0 10px;
      }

      /* 设置文字颜色为浅色，hover后浅色 */
      .page_change_btn.white {
        color: #fff;
      }

      .page_change_btn.white:hover {
        color: aqua;
        background-color: rgba(255, 255, 255, 0.149);
      }

      /* 图标均用向下的图标，向上设置旋转180°*/
      .page_change_btn.pre > .menu_icon {
        color: #bd1c1c;
        transform: rotate(180deg);
      }

      /* 设置文字颜色为深色，hover后深色 */

      .page_change_btn.black {
        color: #fff;
      }

      .page_change_btn.black:hover {
        color: aqua;
        /* background-color: rgba(255, 255, 255, 0.149); */
      }

      /* 图标均用向下的图标，向上设置旋转180°*/
      .page_change_btn.pre > .menu_icon {
        color: #fff;
        transform: rotate(180deg);
      }
    </style>
  </head>

  <body>
    <div class="swiper swiper-no-swiping">
      <div class="swiper-wrapper">
        <div class="swiper-slide">
          <div class="home_pre">
            <div class="content">
              <div class="heading">HONG KONG</div>
            </div>
            <div class="lang_buttons">
              <button id="lang-btn" class="lang_btn next white" data-lang="en">
                EXPLORE（Englishg）
              </button>
              <button id="lang-btn" class="lang_btn next white" data-lang="zh">
                探索（中文）
              </button>
            </div>
          </div>
        </div>

        <div class="swiper-slide">
          <div class="home">
            <div class="page_menu">
              <div class="page_change_btn pre black" id="pre-page">
                <img class="menu_icon" src="static/icon/next_black.svg" />
                <p lang-id="lastMenu">Last Page</p>
              </div>
            </div>

            <img class="intro_pic" src="./static/hongkong3.jpg" alt="" />
            <div class="content">
              <!-- 嵌入容器 + 图片 -->
              <div class="content_embedded">
                <img class="content_pic" lang-id="TitlePic" />
              </div>

              <!-- 文本内容 -->
              <div class="text_area_1">
                <p lang-id="contentTitle">
                  基于 视觉复杂度 的 香港"城市街景索引"
                </p>
              </div>
              <div class="text_area_2">
                <p lang-id="contentText_1">正文1</p>
                <!-- 多张图片并排排列的图片墙 -->
                <div class="content_gallery">
                  <div class="gallery_item">
                    <img src="./static/page2-0.png" />
                  </div>
                </div>

                <p lang-id="contentText_2">正文2</p>
                <!-- 多张图片并排排列的图片墙 -->
                <div class="content_gallery">
                  <div class="gallery_item">
                    <img src="./static/page2-1a.png" />
                  </div>
                </div>
                <div class="pic_text">
                  <p lang-id="picText_1">“安全性”由低到高的街景</p>
                  <a lang-id="picText_2">
                    （图片来源：Nikhil Naik, et al, 2014
                  </a>
                </div>

                <div class="content_gallery">
                  <div class="gallery_item">
                    <img src="./static/page2-1b.png" />
                  </div>
                </div>

                <div class="pic_text">
                  “视觉质量”感知由低到高的街景
                  <a
                    href="https://journals.sagepub.com/doi/10.1177/2399808319828734"
                    >（图片来源：Yu Ye, et al, 2019）</a
                  >
                </div>

                <div class="content_gallery">
                  <div class="gallery_item">
                    <img src="./static/page2-1c.png" />
                  </div>
                </div>

                <div class="pic_text">
                  “美观性”感知由低到高的街景
                  <a
                    href="https://link.springer.com/chapter/10.1007/978-3-319-46448-0_12"
                    >（图片来源：Abhimanyu Dubey, et al, 2016）</a
                  >
                </div>

                <div class="content_gallery">
                  <div class="gallery_item">
                    <img src="./static/page2-1d.png" />
                  </div>
                </div>

                <div class="pic_text">
                  “疗愈性”感知由低到高的街景
                  <a
                    href="https://kns.cnki.net/kcms2/article/abstract?v=3uoqIhG8C44YLTlOAiTRKibYlV5Vjs7i8oRR1PAr7RxjuAJk4dHXoklUCXziRe4nN7iQdbUpdIjhufeCZIXbCx8HnDWJU4U9&uniplatform=NZKPT"
                    >（图片来源：徐磊青, 等, 2020）</a
                  >
                </div>

                <br />3.目前，数字语境下的街景解析通常依靠语义分割认知，即提取街景的天空、建筑、植物、道路等物质构成特征，并以其各自的像素占比来量化。但这种方法只能描述街景的“形态”，却并不能抓住街景的“神韵”。因此，街景纹理、形状、色彩特征的视觉复杂度“另辟蹊径”，为城市形象认知提供了一个新颖的探索角度。同时，也可作为现有方法的有效补充，在数字语境下更全面的掌握城市街景形象。

                <div class="content_gallery">
                  <div class="gallery_item">
                    <img src="./static/page2-2a.png" />
                  </div>
                </div>
                <div class="content_gallery">
                  <div class="gallery_item">
                    <img src="./static/page2-2b.png" />
                  </div>
                </div>

                <div class="pic_text">
                  物质构成相似的街景却有着完全不同的视觉感受
                </div>

                <!-- 嵌入容器 + 视频 -->
                <div class="content_embedded">
                  <div class="video_area">
                    <video src="static/video.mp4" controls></video>
                  </div>
                </div>
                <p lang-id="contentText_3">
                  3.目前，数字语境下的街景解析通常依靠语义分割认知，即提取街景的天空、建筑、植物、道路等物质构成特征，并以其各自的像素占比来量化。但这种方法只能描述街景的“形态”，却并不能抓住街景的“神韵”。因此，街景纹理、形状、色彩特征的视觉复杂度“另辟蹊径”，为城市形象认知提供了一个新颖的探索角度。同时，也可作为现有方法的有效补充，在数字语境下更全面的掌握城市街景形象。
                </p>
              </div>
            </div>

            <div class="page_menu">
              <div class="page_change_btn next white" id="next-page">
                <img
                  class="menu_icon"
                  src="static/icon/next_white.svg"
                  alt=""
                />
                <p id="nextMenu">Next Page</p>
              </div>
            </div>
          </div>
        </div>
        <div class="swiper-slide">
          <div class="app">
            <div class="aside">
              <!-- <div class="load" id="load" value-success="HongKong Streetscape Indexing">Loading</div> -->
              <div class="range_container">
                <div class="range_item">
                  <div class="label_container">
                    <div class="range_label" id="x-label" lang-id="texture">
                      纹理：
                    </div>
                    <span class="label_container_tips">tips</span>
                  </div>
                  <div class="range_btn_group">
                    <span lang-id="range_btn_low">低</span>
                    <div class="range_btn" id="range-btn-x"></div>
                    <span lang-id="range_btn_hign">高</span>
                  </div>
                </div>
                <div class="range_item">
                  <div class="label_container">
                    <div class="range_label" id="y-label" lang-id="shape">
                      形状：
                    </div>
                    <span class="label_container_tips">tips</span>
                  </div>
                  <div class="range_btn_group">
                    <span lang-id="range_btn_low">低</span>
                    <div class="range_btn" id="range-btn-y"></div>
                    <span lang-id="range_btn_hign">高</span>
                  </div>
                </div>
                <div class="range_item">
                  <div class="label_container">
                    <div class="range_label" id="z-label" lang-id="color">
                      色彩：
                    </div>
                    <span class="label_container_tips">tips</span>
                  </div>
                  <div class="range_btn_group">
                    <span lang-id="range_btn_low">低</span>
                    <div class="range_btn" id="range-btn-z"></div>
                    <span lang-id="range_btn_hign">高</span>
                  </div>
                </div>
                <div class="layui-btn-container">
                  <div
                    class="layui-btn layui-btn-left layui-btn-primary layui-btn-custom"
                    id="init-btn"
                    lang-id="default"
                  >
                    DEFAULT
                  </div>
                  <div
                    class="layui-btn layui-btn-right layui-btn-primary layui-btn-custom"
                    id="draw-btn"
                    lang-id="find"
                  >
                    Find Geo-location
                  </div>
                </div>
              </div>
              <div id="container" style="height: 500px"></div>
            </div>
            <div class="main">
              <div class="page_menu">
                <div class="page_change_btn pre black" id="pre-page">
                  <img class="menu_icon" src="static/icon/next_black.svg" />
                  <span>Last Page</span>
                </div>
              </div>
              <!-- 图片渲染容器 -->
              <div class="pics" id="pics"></div>
              <div class="page_menu">
                <div class="page_change_btn next black" id="next-page">
                  <img
                    class="menu_icon"
                    src="static/icon/next_black.svg"
                    alt=""
                  />
                  <span>Next Page</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import resolvePictures from "./src/resolvePictures.js";
      import pictureFunctionComponent from "./src/pictrueFunctionComponent.js";
      import rangeFunctionComponent from "./src/rangeFunctionComponent.js";
      import resolveConfig from "./src/resolveConfig.js";
      import resolveXLSX from "./src/resolveXLSX.js";
      import readData from "./src/readData.js";
      import {
        useRangeInput,
        useRangeInputCallback,
        ranges,
      } from "./src/useRangeInput.js";
      import { loadMap, readCoordinate } from "./src/loadMap.js";
      import useSwiper from "./src/useSwiper.js";

      //上一页和下一页按钮
      const prePage = document.querySelectorAll("#pre-page");
      const nextPage = document.querySelectorAll("#next-page");

      //页面滚动
      const { slideNext, slidePrev } = useSwiper({
        query: ".swiper",
      });

      for (let i = 0; i < prePage.length; i++) {
        prePage[i].onclick = () => {
          slidePrev();
        };
      }

      for (let i = 0; i < nextPage.length; i++) {
        nextPage[i].onclick = () => {
          slideNext();
        };
      }

      const LANGUAGE_KEY = "_lang";
      //加载语言的内容
      async function loadLangContent() {
        const lang = window.localStorage.getItem(LANGUAGE_KEY) || "en" || "zh";
        const langConfig = await import("./langConfig.js").then(
          (res) => res.default
        );
        const elementIds = Object.keys(langConfig);

        const targetAndContent = [];

        elementIds.forEach((elementId) => {
          const target = document.querySelectorAll(`[lang-id=${elementId}]`);
          let isConnection = false;
          let isImg = false;

          if (!(target instanceof HTMLElement)) {
            isConnection = true;
          }

          if (isConnection) {
            for (let i = 0; i < target.length; i++) {
              targetAndContent.push({
                target: target[i],
                content: langConfig[elementId][lang],
                attribute: langConfig[elementId]["attr"]
                  ? langConfig[elementId]["attr"]
                  : null,
              });
            }
          } else {
            targetAndContent.push({
              target: target[i],
              content: langConfig[elementId][lang],
              attribute: langConfig[elementId]["attr"]
                ? langConfig[elementId]["attr"]
                : null,
            });
          }
        });

        targetAndContent.forEach(({ target, content, attribute }) => {
          const type = target.tagName;

          if (attribute !== null) {
            target.setAttribute(attribute, content);
          } else {
            if (type === "IMG") {
              target.src = content;
            } else {
              target.innerHTML = content;
            }
          }
        });
      }

      //语言按钮
      const langBtns = document.querySelectorAll("#lang-btn");
      langBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          window.localStorage.setItem(
            LANGUAGE_KEY,
            btn.dataset.lang || "en" || "zh"
          );
          loadLangContent();
          slideNext();
        });
      });

      // ---------------------------------加载可自定义配置文件---------------------------------------------
      resolveConfig("./config.json").then(async (config) => {
        // ------------------------------统一获取dom元素------------------------------------------
        const container = document.getElementById("pics");
        const rangeContainer = document.getElementById("range-container");
        // const load = document.getElementById("load")
        const axisX = document.getElementById("x-label");
        const axisY = document.getElementById("y-label");
        const axisZ = document.getElementById("z-label");
        const initBtn = document.getElementById("init-btn");
        const drawBtn = document.getElementById("draw-btn");

        const xyzDatas = []; //加载完的3个表格的数据

        // ----------------------------侧边栏坐标范围条-----------------------------------------
        function setPosition(targetXYZ) {
          const { targetX, targetY, targetZ } = targetXYZ;
          axisX.innerText = `纹理 Texture：[${targetX[0]},${targetX[1]}]`;
          axisY.innerText = `形状 Shape：[${targetY[0]},${targetY[1]}]`;
          axisZ.innerText = `色彩 Color：[${targetZ[0]},${targetZ[1]}]`;
        }

        const sliders = useRangeInput(
          [
            {
              id: "#range-btn-x",
              index: "x",
            },
            {
              id: "#range-btn-y",
              index: "y",
            },
            {
              id: "#range-btn-z",
              index: "z",
            },
          ],
          {
            defaultRangeLeft: config.rangeDefaultValue[0][0],
            defaultRangeRight: config.rangeDefaultValue[0][1],
          },
          () => {
            const defaultValue = config.rangeDefaultValue[0];
            setPosition({
              targetX: defaultValue,
              targetY: defaultValue,
              targetZ: defaultValue,
            });
          }
        );

        // 加载地图
        const { clearAndmark } = loadMap("container", {
          markRadius: config.markRadius[0],
        });

        // 阻塞加载坐标数据
        const coordinate = await readCoordinate();

        // ---------------------------------阻塞渲染图片DOM---------------------------------------------
        const { updateSelectIdList, updateClickIdList, render, state } =
          pictureFunctionComponent(container);
        await render(
          config.path[0],
          config.count[0],
          config.numberPerRow[0],
          config
        ); //路径和需要渲染的图片数目

        // ----------------------------坐标数据-----------------------------------------
        const { calcIds, setXyzDatas } = rangeFunctionComponent();

        // ---------------------------------阻塞加载表格数据---------------------------------------------
        await readData("./data", ["C1.xlsx", "C2.xlsx", "C3.xlsx"]).then(
          (res) => {
            const datas = Array.from({ length: config.count[0] }).map(
              (item, index) => {
                return {
                  x: res[0][index],
                  y: res[1][index],
                  z: res[2][index],
                  id: index,
                };
              }
            );

            // load.innerText = load.getAttribute("value-success")
            // load.classList.add("success")
            setXyzDatas(datas);
          }
        );

        // ----------------------------侧边栏地图-----------------------------------------

        //手动选择滑块之后的触发更新
        useRangeInputCallback(() => {
          // 计算处于滑块中的内容 -> 更新处于滑块中的图片的高亮状态
          const targetIds = calcIds(ranges, (targetXYZ) => {
            const { targetX, targetY, targetZ } = targetXYZ;
            setPosition(targetXYZ);
          });
          updateSelectIdList(targetIds);
        });

        //初始化滑块
        function initAxisRange() {
          const rangeDefaultValue = config.rangeDefaultValue[0];

          ["x", "y", "z"].forEach((index) => {
            ranges[index].splice(0);
            ranges[index].push(rangeDefaultValue);
          });
          [0, 1, 2].forEach((index) => {
            sliders[index].setValue(rangeDefaultValue[0] * Math.pow(10, 15), 0);
            sliders[index].setValue(rangeDefaultValue[1] * Math.pow(10, 15), 1);
          });

          updateClickIdList([]);
          updateSelectIdList([]);
          drawMarker();
        }

        // 标记点
        function drawMarker() {
          const markIds = [
            ...state.selectIdList.map((selectId) => parseInt(selectId)),
            ...state.clickIdList.map((clickId) => parseInt(clickId)),
          ];

          clearAndmark(coordinate, markIds);
        }

        // 绑定默认加载的点击事件
        initBtn.onclick = initAxisRange;
        drawBtn.onclick = drawMarker;
      });
    </script>
  </body>
</html>
